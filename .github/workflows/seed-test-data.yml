name: Seed Test Data

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (staging only - production blocked)'
        required: true
        type: choice
        options:
          - staging
          - staging-healthcare-india
      confirm:
        description: 'Type "seed" to confirm'
        required: true
        type: string

  # Can also be called from other workflows (e.g., post-deployment)
  workflow_call:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string

jobs:
  seed:
    name: Seed Test Data
    runs-on: ubuntu-latest
    # For workflow_dispatch: require confirmation. For workflow_call: always run.
    if: ${{ inputs.confirm == 'seed' || github.event_name == 'workflow_call' }}

    steps:
      - name: Block production
        if: startsWith(inputs.environment, 'production')
        run: |
          echo "‚ùå Cannot seed test data in production!"
          exit 1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_INTERNAL }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_INTERNAL }}
          aws-region: ${{ inputs.environment == 'staging' && 'eu-central-1' || 'ap-south-1' }}

      - name: Get Customer Portal endpoint
        id: endpoint
        run: |
          # Find the stack
          STACK_NAME=$(aws cloudformation list-stacks \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --query "StackSummaries[?starts_with(StackName, 'axonflow-${{ inputs.environment }}')].StackName | sort(@) | [-1]" \
            --output text)

          if [ -z "$STACK_NAME" ] || [ "$STACK_NAME" = "None" ]; then
            echo "‚ùå No stack found for environment: ${{ inputs.environment }}"
            exit 1
          fi

          echo "stack_name=$STACK_NAME" >> $GITHUB_OUTPUT

          # Get Customer Portal endpoint
          CP_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].Outputs[?OutputKey=='CustomerPortalEndpoint'].OutputValue" \
            --output text)

          if [ -z "$CP_ENDPOINT" ] || [ "$CP_ENDPOINT" = "None" ]; then
            echo "‚ùå CustomerPortalEndpoint not found in stack outputs"
            exit 1
          fi

          echo "endpoint=$CP_ENDPOINT" >> $GITHUB_OUTPUT
          echo "üìç Stack: $STACK_NAME"
          echo "üìç Customer Portal endpoint: $CP_ENDPOINT"

      - name: Seed test organizations
        id: seed
        env:
          ENDPOINT: ${{ steps.endpoint.outputs.endpoint }}
        run: |
          # Function to create/update an organization
          seed_org() {
            local ORG_ID="$1"
            local ORG_NAME="$2"
            local PASSWORD="$3"
            local TIER="${4:-PRO}"

            echo "Creating $ORG_ID..."

            # Use --max-time to prevent hanging, -k to skip SSL verification (ALB uses self-signed cert)
            RESPONSE=$(curl -sk --max-time 30 "${ENDPOINT}/api/v1/admin/onboard-customer" \
              -H "Content-Type: application/json" \
              -d "{
                \"org_id\": \"$ORG_ID\",
                \"name\": \"$ORG_NAME\",
                \"tier\": \"$TIER\",
                \"validity_days\": 3650,
                \"password\": \"$PASSWORD\"
              }" 2>&1)

            # Check response
            if echo "$RESPONSE" | grep -q '"success":true'; then
              echo "‚úÖ $ORG_ID created/updated successfully"
              return 0
            else
              echo "‚ö†Ô∏è Response for $ORG_ID: $RESPONSE"
              # The onboard endpoint uses ON CONFLICT DO UPDATE, so even "errors" may succeed
              # We'll verify with login in the next step
              return 0
            fi
          }

          # Seed test organizations
          seed_org "test-org-001" "Test Organization" "test123" "PRO"
          seed_org "e2e-test-saas" "E2E Test Organization" "E2ETestPassword123" "PRO"

      - name: Verify logins
        env:
          ENDPOINT: ${{ steps.endpoint.outputs.endpoint }}
        run: |
          # Function to verify login
          verify_login() {
            local ORG_ID="$1"
            local PASSWORD="$2"

            echo "Verifying $ORG_ID can login..."

            RESPONSE=$(curl -sk --max-time 30 -w "\n%{http_code}" "${ENDPOINT}/api/v1/auth/login" \
              -H "Content-Type: application/json" \
              -d "{\"org_id\":\"$ORG_ID\",\"password\":\"$PASSWORD\"}")

            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ $ORG_ID login successful"
              return 0
            else
              echo "‚ùå $ORG_ID login failed (HTTP $HTTP_CODE)"
              echo "Response: $BODY"
              return 1
            fi
          }

          # Verify both organizations can login
          FAILED=0
          verify_login "test-org-001" "test123" || FAILED=1
          verify_login "e2e-test-saas" "E2ETestPassword123" || FAILED=1

          if [ "$FAILED" = "1" ]; then
            echo ""
            echo "‚ùå Some logins failed. Check the admin/onboard-customer endpoint."
            exit 1
          fi

      - name: Summary
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ Test data seeded successfully!"
          echo "========================================="
          echo ""
          echo "Test Credentials:"
          echo "  - test-org-001 / test123"
          echo "  - e2e-test-saas / E2ETestPassword123"
          echo ""
          echo "E2E tests should now pass."
