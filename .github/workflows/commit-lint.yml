name: Commit Lint
# Test: Merge queue scenario 1 - workflow file only change

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  commitlint:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        run: |
          # Only check PR title (which becomes the squash commit message)
          # This allows historical commits to remain unchanged
          PR_TITLE="${{ github.event.pull_request.title }}"

          echo "Checking PR title: $PR_TITLE"

          # Check if PR title follows Conventional Commits format
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|build|chore|ci|docs|perf|refactor|style|test)(\(.+\))?: .{1,72}$'; then
            echo ""
            echo "‚ùå Invalid PR title: $PR_TITLE"
            echo ""
            echo "PR titles must follow Conventional Commits format:"
            echo "  Format: <type>(<scope>): <subject>"
            echo "  Types: feat, fix, build, chore, ci, docs, perf, refactor, style, test"
            echo "  Max length: 72 characters"
            echo ""
            echo "Examples:"
            echo "  ‚úÖ feat(api): add user endpoint"
            echo "  ‚úÖ fix: resolve authentication bug"
            echo "  ‚úÖ build: update Go version to 1.23"
            echo "  ‚úÖ ci: add code coverage reporting"
            echo "  ‚úÖ refactor(agent): improve error handling"
            echo ""
            echo "Why: PR title becomes the commit message when using 'Squash and merge'"
            echo "See: https://www.conventionalcommits.org/"
            exit 1
          fi

          echo "‚úÖ PR title follows Conventional Commits format"

      - name: Check for AI attribution in PR description
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR description for AI attribution..."

          # Check for AI attribution patterns
          if echo "$PR_BODY" | grep -qE 'ü§ñ|Generated with.*Claude|Co-Authored-By:.*Claude|noreply@anthropic'; then
            echo ""
            echo "‚ùå AI attribution found in PR description"
            echo ""
            echo "Please remove the following from your PR description:"
            echo "  - ü§ñ Generated with Claude Code"
            echo "  - Co-Authored-By: Claude <noreply@anthropic.com>"
            echo "  - Any other AI attribution text"
            echo ""
            echo "Why: Company policy - no AI attribution in commits or PRs"
            exit 1
          fi

          echo "‚úÖ No AI attribution found in PR description"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for AI attribution in PR commits
        run: |
          echo "Checking all PR commits for AI attribution..."
          echo ""

          # Get the base and head refs
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Checking commits from $BASE_SHA to $HEAD_SHA"
          echo ""

          # Use git log --grep to efficiently find commits with attribution patterns
          # Check each pattern separately since --grep uses OR logic
          FOUND_COMMITS=""

          for PATTERN in "ü§ñ" "Generated with.*Claude" "Co-Authored-By:.*Claude" "noreply@anthropic"; do
            MATCHES=$(git log --grep="$PATTERN" -E --format='%h %s' $BASE_SHA..$HEAD_SHA 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              FOUND_COMMITS="${FOUND_COMMITS}${MATCHES}"$'\n'
            fi
          done

          if [ -n "$FOUND_COMMITS" ]; then
            echo "‚ùå AI attribution found in the following commits:"
            echo ""
            echo "$FOUND_COMMITS" | sort -u | while read -r line; do
              [ -n "$line" ] && echo "  $line"
            done
            echo ""
            echo "Why this matters: When using 'Squash and merge', all commit messages"
            echo "are concatenated into the final commit body. AI attribution in any"
            echo "individual commit will end up in the squashed commit."
            echo ""
            echo "To fix: Rebase and reword the affected commits to remove attribution:"
            echo "  git rebase -i origin/main"
            echo "  # Change 'pick' to 'reword' for affected commits"
            echo "  # Remove the AI attribution lines"
            echo "  git push --force-with-lease"
            echo ""
            exit 1
          fi

          echo "‚úÖ No AI attribution found in PR commits"
