name: Update Documentation

on:
  push:
    branches: [ main, dev-until-jan9 ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  update-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bc
        
    - name: Generate code metrics
      run: |
        chmod +x ./scripts/generate-code-metrics.sh
        ./scripts/generate-code-metrics.sh
        
    - name: Extract API documentation
      run: |
        chmod +x ./scripts/extract-api-docs.sh
        ./scripts/extract-api-docs.sh
        
    - name: Update compliance matrix
      run: |
        chmod +x ./scripts/update-compliance-matrix.sh
        ./scripts/update-compliance-matrix.sh
        
    - name: Check for documentation changes
      id: docs_changed
      run: |
        if git diff --quiet docs/generated/; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit updated documentation
      if: steps.docs_changed.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/generated/
        git commit -m "Auto-update generated documentation

        - Code metrics updated
        - API documentation refreshed  
        - Compliance matrix updated
        
        Generated by GitHub Actions"
        
    - name: Push changes
      if: steps.docs_changed.outputs.changed == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create documentation summary
      run: |
        echo "## Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Metrics**: $([ -f docs/generated/code-metrics.md ] && echo "✅ Updated" || echo "❌ Failed")" >> $GITHUB_STEP_SUMMARY
        echo "- **API Docs**: $([ -f docs/generated/api-documentation.md ] && echo "✅ Updated" || echo "❌ Failed")" >> $GITHUB_STEP_SUMMARY
        echo "- **Compliance Matrix**: $([ -f docs/generated/compliance-matrix.md ] && echo "✅ Updated" || echo "❌ Failed")" >> $GITHUB_STEP_SUMMARY
        
        if [ -f docs/generated/metrics-summary.env ]; then
          echo "## Metrics Summary" >> $GITHUB_STEP_SUMMARY
          source docs/generated/metrics-summary.env
          echo "- **Total Lines of Code**: $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Files**: $GO_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **JS/TS Files**: $JS_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Score**: $SECURITY_SCORE" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f docs/generated/compliance-summary.env ]; then
          echo "## Compliance Summary" >> $GITHUB_STEP_SUMMARY
          source docs/generated/compliance-summary.env
          echo "- **HIPAA Ready**: $([ "$HIPAA_READY" = "true" ] && echo "✅ Yes" || echo "❌ No")" >> $GITHUB_STEP_SUMMARY
          echo "- **GDPR Ready**: $([ "$GDPR_READY" = "true" ] && echo "✅ Yes" || echo "❌ No")" >> $GITHUB_STEP_SUMMARY
          echo "- **SOX Ready**: $([ "$SOX_READY" = "true" ] && echo "✅ Yes" || echo "❌ No")" >> $GITHUB_STEP_SUMMARY
          echo "- **Overall Score**: ${OVERALL_COMPLIANCE_SCORE}%" >> $GITHUB_STEP_SUMMARY
        fi

  validate-documentation:
    runs-on: ubuntu-latest
    needs: update-docs
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate documentation links
      run: |
        # Check for broken internal links
        find docs/ -name "*.md" -exec grep -l "\[.*\](" {} + | while read -r file; do
          echo "Checking links in $file"
          # Extract links and validate they exist
          grep -o '\[.*\]([^)]*\.md[^)]*)' "$file" | while read -r link; do
            target=$(echo "$link" | grep -o '([^)]*.md[^)]*)' | tr -d '()')
            if [ ! -f "docs/$target" ] && [ ! -f "$target" ]; then
              echo "⚠️  Broken link in $file: $target"
            fi
          done
        done
        
    - name: Check documentation completeness
      run: |
        echo "## Documentation Completeness Check" >> $GITHUB_STEP_SUMMARY
        
        # Check if all components have documentation
        components=("platform/agent" "platform/orchestrator" "platform/clients/support-demo")
        for component in "${components[@]}"; do
          if [ -d "$component" ]; then
            if [ -f "$component/README.md" ]; then
              echo "- **$component**: ✅ Has README" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **$component**: ❌ Missing README" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        # Check if generated docs exist
        generated_docs=("code-metrics.md" "api-documentation.md" "compliance-matrix.md")
        for doc in "${generated_docs[@]}"; do
          if [ -f "docs/generated/$doc" ]; then
            echo "- **$doc**: ✅ Generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **$doc**: ❌ Missing" >> $GITHUB_STEP_SUMMARY
          fi
        done
