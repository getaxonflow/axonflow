name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - develop
    paths:
      # Dockerfiles that get built
      - 'platform/*/Dockerfile'
      - 'platform/monitoring/Dockerfile'
      - 'grafana/Dockerfile'
      # Go source code that gets compiled into images (excluding test files)
      # Note: GitHub Actions doesn't support negation in paths, so we list specific directories
      - 'platform/agent/*.go'
      - 'platform/agent/**/*.go'
      - 'platform/orchestrator/*.go'
      - 'platform/orchestrator/**/*.go'
      - 'platform/connectors/**/*.go'
      - 'platform/common/**/*.go'
      - 'platform/cmd/**/*.go'
      - 'platform/**/go.mod'
      - 'platform/**/go.sum'
      # Enterprise overlay (critical for Agent build)
      - 'ee/platform/agent/**/*.go'
      - 'ee/platform/orchestrator/**/*.go'
      - 'ee/platform/connectors/**/*.go'
      - 'ee/platform/customer-portal/**'
      - 'ee/platform/customer-portal-ui/**'
      - 'ee/platform/**/go.mod'
      - 'ee/platform/**/go.sum'
      # Migrations baked into images
      - 'migrations/**/*.sql'
      # Grafana dashboards and config
      - 'grafana/**'
      # Build workflow itself
      - '.github/workflows/build.yml'
  # Merge queue: Docker builds run when PR is ready to merge
  # This provides 83% reduction in Docker build jobs while ensuring main stays clean
  # See: https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/managing-a-merge-queue
  merge_group:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      edition:
        description: 'Build edition (oss or enterprise)'
        required: true
        default: 'enterprise'
        type: choice
        options:
          - enterprise
          - oss

env:
  AWS_REGION: eu-central-1
  ECR_REGISTRY: 686831565523.dkr.ecr.eu-central-1.amazonaws.com
  # Default to 'enterprise' for this enterprise repo - all builds should include enterprise features
  EDITION: ${{ github.event.inputs.edition || 'enterprise' }}

jobs:
  build-agent:
    name: Build Agent Image
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate build metadata
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          # Handle different ref formats
          if [[ "$GITHUB_REF" == refs/pull/* ]]; then
            # PR refs: refs/pull/14/merge -> pr-14
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|refs/pull/\([0-9]*\)/.*|\1|')
            BRANCH="pr-${PR_NUM}"
          elif [[ "$GITHUB_REF" == refs/heads/gh-readonly-queue/* ]]; then
            # Merge queue refs: refs/heads/gh-readonly-queue/main/pr-123-abc -> mq-123
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|.*/pr-\([0-9]*\)-.*|\1|')
            BRANCH="mq-${PR_NUM}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi
          # Sanitize branch name for Docker tag (replace slashes with dashes, lowercase)
          SAFE_BRANCH=$(echo "$BRANCH" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          # Set is_main for conditional latest tag
          [[ "$SAFE_BRANCH" == "main" ]] && echo "is_main=true" >> $GITHUB_OUTPUT || echo "is_main=false" >> $GITHUB_OUTPUT

      - name: Build and push agent image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./platform/agent/Dockerfile
          push: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_REGISTRY }}/axonflow-agent:${{ steps.meta.outputs.short_sha }}
            ${{ env.ECR_REGISTRY }}/axonflow-agent:${{ steps.meta.outputs.branch }}-latest
            ${{ env.ECR_REGISTRY }}/axonflow-agent:${{ steps.meta.outputs.timestamp }}
            ${{ steps.meta.outputs.is_main == 'true' && format('{0}/axonflow-agent:latest', env.ECR_REGISTRY) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            EDITION=${{ env.EDITION }}
            GIT_COMMIT=${{ steps.meta.outputs.short_sha }}
            BUILD_DATE=${{ steps.meta.outputs.timestamp }}

      - name: Output image tags
        run: |
          echo "‚úÖ Agent image built successfully (edition: ${{ env.EDITION }})"
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Tags:"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-agent:${{ steps.meta.outputs.short_sha }}"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-agent:${{ steps.meta.outputs.branch }}-latest"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-agent:${{ steps.meta.outputs.timestamp }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "Merge queue build - validating before merge (image not pushed)"
          else
            echo "Validation build - image not pushed to ECR"
          fi

  build-orchestrator:
    name: Build Orchestrator Image
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate build metadata
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          # Handle different ref formats
          if [[ "$GITHUB_REF" == refs/pull/* ]]; then
            # PR refs: refs/pull/14/merge -> pr-14
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|refs/pull/\([0-9]*\)/.*|\1|')
            BRANCH="pr-${PR_NUM}"
          elif [[ "$GITHUB_REF" == refs/heads/gh-readonly-queue/* ]]; then
            # Merge queue refs: refs/heads/gh-readonly-queue/main/pr-123-abc -> mq-123
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|.*/pr-\([0-9]*\)-.*|\1|')
            BRANCH="mq-${PR_NUM}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi
          # Sanitize branch name for Docker tag (replace slashes with dashes, lowercase)
          SAFE_BRANCH=$(echo "$BRANCH" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          # Set is_main for conditional latest tag
          [[ "$SAFE_BRANCH" == "main" ]] && echo "is_main=true" >> $GITHUB_OUTPUT || echo "is_main=false" >> $GITHUB_OUTPUT

      - name: Build and push orchestrator image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./platform/orchestrator/Dockerfile
          push: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_REGISTRY }}/axonflow-orchestrator:${{ steps.meta.outputs.short_sha }}
            ${{ env.ECR_REGISTRY }}/axonflow-orchestrator:${{ steps.meta.outputs.branch }}-latest
            ${{ env.ECR_REGISTRY }}/axonflow-orchestrator:${{ steps.meta.outputs.timestamp }}
            ${{ steps.meta.outputs.is_main == 'true' && format('{0}/axonflow-orchestrator:latest', env.ECR_REGISTRY) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            EDITION=${{ env.EDITION }}
            GIT_COMMIT=${{ steps.meta.outputs.short_sha }}
            BUILD_DATE=${{ steps.meta.outputs.timestamp }}

      - name: Output image tags
        run: |
          echo "‚úÖ Orchestrator image built successfully (edition: ${{ env.EDITION }})"
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Tags:"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-orchestrator:${{ steps.meta.outputs.short_sha }}"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-orchestrator:${{ steps.meta.outputs.branch }}-latest"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-orchestrator:${{ steps.meta.outputs.timestamp }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "Merge queue build - validating before merge (image not pushed)"
          else
            echo "Validation build - image not pushed to ECR"
          fi

  build-customer-portal:
    name: Build Customer Portal Image
    runs-on: ubuntu-latest
    # Only build enterprise components when edition is enterprise (default)
    # Note: github.event.inputs only exists for workflow_dispatch, so we must handle all cases:
    # - push/merge_group: always build enterprise (inputs is empty, default to enterprise)
    # - workflow_dispatch: only build if edition != 'oss'
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.edition != 'oss' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Note: No "Set up Go" step needed - Docker multi-stage build uses golang:1.25-alpine

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate build metadata
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [[ "$GITHUB_REF" == refs/pull/* ]]; then
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|refs/pull/\([0-9]*\)/.*|\1|')
            BRANCH="pr-${PR_NUM}"
          elif [[ "$GITHUB_REF" == refs/heads/gh-readonly-queue/* ]]; then
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|.*/pr-\([0-9]*\)-.*|\1|')
            BRANCH="mq-${PR_NUM}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi
          SAFE_BRANCH=$(echo "$BRANCH" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          [[ "$SAFE_BRANCH" == "main" ]] && echo "is_main=true" >> $GITHUB_OUTPUT || echo "is_main=false" >> $GITHUB_OUTPUT

      - name: Build and push customer-portal image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./ee/platform/customer-portal/Dockerfile
          push: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_REGISTRY }}/axonflow-customer-portal:${{ steps.meta.outputs.short_sha }}
            ${{ env.ECR_REGISTRY }}/axonflow-customer-portal:${{ steps.meta.outputs.branch }}-latest
            ${{ env.ECR_REGISTRY }}/axonflow-customer-portal:${{ steps.meta.outputs.timestamp }}
            ${{ steps.meta.outputs.is_main == 'true' && format('{0}/axonflow-customer-portal:latest', env.ECR_REGISTRY) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image tags
        run: |
          echo "‚úÖ Customer Portal image built successfully"
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Tags:"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-customer-portal:${{ steps.meta.outputs.short_sha }}"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-customer-portal:${{ steps.meta.outputs.branch }}-latest"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-customer-portal:${{ steps.meta.outputs.timestamp }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "Merge queue build - validating before merge (image not pushed)"
          else
            echo "Validation build - image not pushed to ECR"
          fi

  build-customer-portal-ui:
    name: Build Customer Portal UI Image
    runs-on: ubuntu-latest
    # See build-customer-portal for explanation of this condition
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.edition != 'oss' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate build metadata
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [[ "$GITHUB_REF" == refs/pull/* ]]; then
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|refs/pull/\([0-9]*\)/.*|\1|')
            BRANCH="pr-${PR_NUM}"
          elif [[ "$GITHUB_REF" == refs/heads/gh-readonly-queue/* ]]; then
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|.*/pr-\([0-9]*\)-.*|\1|')
            BRANCH="mq-${PR_NUM}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi
          SAFE_BRANCH=$(echo "$BRANCH" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          [[ "$SAFE_BRANCH" == "main" ]] && echo "is_main=true" >> $GITHUB_OUTPUT || echo "is_main=false" >> $GITHUB_OUTPUT

      - name: Build and push customer-portal-ui image
        uses: docker/build-push-action@v5
        with:
          context: ./ee/platform/customer-portal-ui
          file: ./ee/platform/customer-portal-ui/Dockerfile
          push: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_REGISTRY }}/axonflow-customer-portal-ui:${{ steps.meta.outputs.short_sha }}
            ${{ env.ECR_REGISTRY }}/axonflow-customer-portal-ui:${{ steps.meta.outputs.branch }}-latest
            ${{ env.ECR_REGISTRY }}/axonflow-customer-portal-ui:${{ steps.meta.outputs.timestamp }}
            ${{ steps.meta.outputs.is_main == 'true' && format('{0}/axonflow-customer-portal-ui:latest', env.ECR_REGISTRY) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image tags
        run: |
          echo "‚úÖ Customer Portal UI image built successfully"
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Tags:"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-customer-portal-ui:${{ steps.meta.outputs.short_sha }}"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-customer-portal-ui:${{ steps.meta.outputs.branch }}-latest"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-customer-portal-ui:${{ steps.meta.outputs.timestamp }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "Merge queue build - validating before merge (image not pushed)"
          else
            echo "Validation build - image not pushed to ECR"
          fi

  build-prometheus:
    name: Build Prometheus Image
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate build metadata
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          # Handle different ref formats
          if [[ "$GITHUB_REF" == refs/pull/* ]]; then
            # PR refs: refs/pull/14/merge -> pr-14
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|refs/pull/\([0-9]*\)/.*|\1|')
            BRANCH="pr-${PR_NUM}"
          elif [[ "$GITHUB_REF" == refs/heads/gh-readonly-queue/* ]]; then
            # Merge queue refs: refs/heads/gh-readonly-queue/main/pr-123-abc -> mq-123
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|.*/pr-\([0-9]*\)-.*|\1|')
            BRANCH="mq-${PR_NUM}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi
          SAFE_BRANCH=$(echo "$BRANCH" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          # Set is_main for conditional latest tag
          [[ "$SAFE_BRANCH" == "main" ]] && echo "is_main=true" >> $GITHUB_OUTPUT || echo "is_main=false" >> $GITHUB_OUTPUT

      - name: Build and push prometheus image
        uses: docker/build-push-action@v5
        with:
          context: ./platform/monitoring
          file: ./platform/monitoring/Dockerfile
          push: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_REGISTRY }}/axonflow-prometheus:${{ steps.meta.outputs.short_sha }}
            ${{ env.ECR_REGISTRY }}/axonflow-prometheus:${{ steps.meta.outputs.branch }}-latest
            ${{ env.ECR_REGISTRY }}/axonflow-prometheus:${{ steps.meta.outputs.timestamp }}
            ${{ steps.meta.outputs.is_main == 'true' && format('{0}/axonflow-prometheus:latest', env.ECR_REGISTRY) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image tags
        run: |
          echo "‚úÖ Prometheus image built successfully"
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Tags:"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-prometheus:${{ steps.meta.outputs.short_sha }}"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-prometheus:${{ steps.meta.outputs.branch }}-latest"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-prometheus:${{ steps.meta.outputs.timestamp }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "Merge queue build - validating before merge (image not pushed)"
          else
            echo "Validation build - image not pushed to ECR"
          fi

  build-grafana:
    name: Build Grafana Image
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate build metadata
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          # Handle different ref formats
          if [[ "$GITHUB_REF" == refs/pull/* ]]; then
            # PR refs: refs/pull/14/merge -> pr-14
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|refs/pull/\([0-9]*\)/.*|\1|')
            BRANCH="pr-${PR_NUM}"
          elif [[ "$GITHUB_REF" == refs/heads/gh-readonly-queue/* ]]; then
            # Merge queue refs: refs/heads/gh-readonly-queue/main/pr-123-abc -> mq-123
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|.*/pr-\([0-9]*\)-.*|\1|')
            BRANCH="mq-${PR_NUM}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi
          SAFE_BRANCH=$(echo "$BRANCH" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          # Set is_main for conditional latest tag
          [[ "$SAFE_BRANCH" == "main" ]] && echo "is_main=true" >> $GITHUB_OUTPUT || echo "is_main=false" >> $GITHUB_OUTPUT

      - name: Build and push grafana image
        uses: docker/build-push-action@v5
        with:
          context: ./grafana
          file: ./grafana/Dockerfile
          push: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_REGISTRY }}/axonflow-grafana:${{ steps.meta.outputs.short_sha }}
            ${{ env.ECR_REGISTRY }}/axonflow-grafana:${{ steps.meta.outputs.branch }}-latest
            ${{ env.ECR_REGISTRY }}/axonflow-grafana:${{ steps.meta.outputs.timestamp }}
            ${{ steps.meta.outputs.is_main == 'true' && format('{0}/axonflow-grafana:latest', env.ECR_REGISTRY) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image tags
        run: |
          echo "‚úÖ Grafana image built successfully"
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Tags:"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-grafana:${{ steps.meta.outputs.short_sha }}"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-grafana:${{ steps.meta.outputs.branch }}-latest"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-grafana:${{ steps.meta.outputs.timestamp }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "Merge queue build - validating before merge (image not pushed)"
          else
            echo "Validation build - image not pushed to ECR"
          fi

  build-performance-testing:
    name: Build Performance Testing Image
    runs-on: ubuntu-latest
    # See build-customer-portal for explanation of this condition
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.edition != 'oss' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate build metadata
        id: meta
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          if [[ "$GITHUB_REF" == refs/pull/* ]]; then
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|refs/pull/\([0-9]*\)/.*|\1|')
            BRANCH="pr-${PR_NUM}"
          elif [[ "$GITHUB_REF" == refs/heads/gh-readonly-queue/* ]]; then
            PR_NUM=$(echo "$GITHUB_REF" | sed 's|.*/pr-\([0-9]*\)-.*|\1|')
            BRANCH="mq-${PR_NUM}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi
          SAFE_BRANCH=$(echo "$BRANCH" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          [[ "$SAFE_BRANCH" == "main" ]] && echo "is_main=true" >> $GITHUB_OUTPUT || echo "is_main=false" >> $GITHUB_OUTPUT

      - name: Build and push performance-testing image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./ee/platform/performance-testing/Dockerfile
          push: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_REGISTRY }}/axonflow-performance-testing:${{ steps.meta.outputs.short_sha }}
            ${{ env.ECR_REGISTRY }}/axonflow-performance-testing:${{ steps.meta.outputs.branch }}-latest
            ${{ env.ECR_REGISTRY }}/axonflow-performance-testing:${{ steps.meta.outputs.timestamp }}
            ${{ steps.meta.outputs.is_main == 'true' && format('{0}/axonflow-performance-testing:latest', env.ECR_REGISTRY) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image tags
        run: |
          echo "‚úÖ Performance Testing image built successfully"
          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Tags:"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-performance-testing:${{ steps.meta.outputs.short_sha }}"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-performance-testing:${{ steps.meta.outputs.branch }}-latest"
            echo "  - ${{ env.ECR_REGISTRY }}/axonflow-performance-testing:${{ steps.meta.outputs.timestamp }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "Merge queue build - validating before merge (image not pushed)"
          else
            echo "Validation build - image not pushed to ECR"
          fi

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-agent, build-orchestrator, build-customer-portal, build-customer-portal-ui, build-prometheus, build-grafana, build-performance-testing]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "üêã Docker Build Complete (edition: ${{ env.EDITION }})"
          echo ""
          echo "=== Core Components ==="
          echo "Agent: ${{ needs.build-agent.result }}"
          echo "Orchestrator: ${{ needs.build-orchestrator.result }}"
          echo "Prometheus: ${{ needs.build-prometheus.result }}"
          echo "Grafana: ${{ needs.build-grafana.result }}"
          echo ""
          echo "=== Enterprise Components ==="
          echo "Customer Portal: ${{ needs.build-customer-portal.result }}"
          echo "Customer Portal UI: ${{ needs.build-customer-portal-ui.result }}"
          echo "Performance Testing: ${{ needs.build-performance-testing.result }}"
          echo ""

          # Check if any core builds failed - this is critical for merge queue
          FAILED=false
          if [[ "${{ needs.build-agent.result }}" != "success" ]] || \
             [[ "${{ needs.build-orchestrator.result }}" != "success" ]] || \
             [[ "${{ needs.build-prometheus.result }}" != "success" ]] || \
             [[ "${{ needs.build-grafana.result }}" != "success" ]]; then
            echo "‚ùå One or more core builds failed"
            FAILED=true
          fi

          # For enterprise builds, also check enterprise components
          # Note: skipped jobs return 'skipped' result when edition=oss
          if [[ "${{ env.EDITION }}" != "oss" ]]; then
            if [[ "${{ needs.build-customer-portal.result }}" != "success" ]] || \
               [[ "${{ needs.build-customer-portal-ui.result }}" != "success" ]] || \
               [[ "${{ needs.build-performance-testing.result }}" != "success" ]]; then
              echo "‚ùå One or more enterprise builds failed"
              FAILED=true
            fi
          fi

          if [[ "$FAILED" == "true" ]]; then
            if [[ "${{ github.event_name }}" == "merge_group" ]]; then
              echo "‚ö†Ô∏è  Merge queue build failed - PR will not be merged"
            fi
            exit 1
          fi

          echo ""
          if [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "‚úÖ Merge queue validation passed - PR is safe to merge"
            echo "‚ÑπÔ∏è  Images built but not pushed (will push after merge)"
          elif [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "‚úÖ All builds successful - images pushed to ECR"
          else
            echo "‚úÖ Validation build completed"
          fi
