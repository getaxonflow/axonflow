openapi: 3.0.3
info:
  title: AxonFlow Orchestrator API
  description: |
    REST API for the AxonFlow Orchestrator service - Dynamic Policy Enforcement, LLM Routing, and Multi-Agent Planning.

    The Orchestrator handles:
    - **Dynamic Policy Evaluation**: Database-backed policy rules with risk scoring
    - **LLM Routing**: Intelligent routing across OpenAI, Anthropic, Bedrock, Ollama
    - **Multi-Agent Planning (MAP)**: LLM-powered task decomposition and parallel execution
    - **Response Processing**: PII detection and redaction
    - **Workflow Execution**: Step-based workflow orchestration
    - **Audit Logging**: Comprehensive request/response logging

    ## Architecture

    ```
    Client → Agent → Orchestrator → LLM Providers
                  ↘ MCP Connectors
    ```

    The Orchestrator receives pre-authenticated requests from the Agent and handles
    complex processing including LLM calls and dynamic policy evaluation.

    ## Internal API

    These endpoints are typically called by the Agent service, not directly by clients.
    For client-facing APIs, see the Agent API specification.

  version: 1.0.0
  contact:
    name: AxonFlow Support
    url: https://getaxonflow.com/support
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: https://orchestrator.getaxonflow.com
    description: Production (SaaS)
  - url: http://localhost:8081
    description: Local Development

tags:
  - name: Health
    description: Service health and readiness
  - name: Processing
    description: Main request processing pipeline
  - name: Multi-Agent Planning
    description: LLM-powered task decomposition and execution
  - name: LLM Providers
    description: LLM provider management
  - name: Dynamic Policies
    description: Runtime policy management
  - name: Workflows
    description: Workflow execution engine
  - name: Connectors
    description: Connector marketplace
  - name: Audit
    description: Audit log search and retrieval
  - name: Metrics
    description: Performance monitoring

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: |
        Returns service health status including component health:
        - Policy Engine
        - LLM Router
        - Response Processor
        - Audit Logger
        - Workflow Engine
        - Planning Engine (MAP)
        - Result Aggregator (MAP)
      operationId: healthCheck
      responses:
        '200':
          description: Service health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                service: axonflow-orchestrator
                version: "1.0.0"
                timestamp: "2025-01-15T10:30:00Z"
                components:
                  policy_engine: true
                  llm_router: true
                  response_processor: true
                  audit_logger: true
                  workflow_engine: true
                  planning_engine: true
                  result_aggregator: true
                features:
                  multi_agent_planning: true

  /metrics:
    get:
      tags:
        - Metrics
      summary: Get performance metrics (JSON)
      description: |
        Returns comprehensive JSON metrics including:
        - Request counts and rates
        - Latency percentiles (P50, P95, P99)
        - Per-stage timing (dynamic policy, LLM)
        - Per-provider metrics (tokens, cost)
        - Health status
      operationId: getMetrics
      responses:
        '200':
          description: Performance metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
              example:
                orchestrator_metrics:
                  uptime_seconds: 3600
                  total_requests: 5000
                  success_requests: 4800
                  failed_requests: 100
                  blocked_requests: 100
                  success_rate: 96.0
                  rps: 1.38
                  error_rate_per_sec: 0.027
                  dynamic_policy_eval_p50_ms: 2.5
                  dynamic_policy_eval_p95_ms: 8.0
                  dynamic_policy_eval_p99_ms: 15.0
                  llm_routing_p50_ms: 500
                  llm_routing_p95_ms: 1500
                  llm_routing_p99_ms: 3000
                health:
                  up: 1
                  consecutive_errors: 0
                providers:
                  openai:
                    total_calls: 3000
                    success_calls: 2950
                    failed_calls: 50
                    total_tokens: 1500000
                    total_cost: 45.50
                    p99_ms: 2500
                  bedrock:
                    total_calls: 2000
                    success_calls: 1990
                    failed_calls: 10
                    total_tokens: 800000
                    total_cost: 12.00
                    p99_ms: 1800
                timestamp: "2025-01-15T10:30:00Z"

  /prometheus:
    get:
      tags:
        - Metrics
      summary: Prometheus metrics endpoint
      description: Returns metrics in Prometheus exposition format
      operationId: getPrometheusMetrics
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string

  /api/v1/process:
    post:
      tags:
        - Processing
      summary: Process orchestrator request
      description: |
        Main processing endpoint. Handles:
        1. Dynamic policy evaluation
        2. LLM provider routing
        3. Response processing (PII detection)
        4. Audit logging
        5. Metrics collection

        **Note**: This endpoint is typically called by the Agent, not directly by clients.
        For MCP queries (`request_type: mcp-query`), routes to the Agent MCP handler.
      operationId: processRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrchestratorRequest'
            examples:
              llmChat:
                summary: LLM chat request
                value:
                  request_id: "req_12345"
                  query: "Summarize the quarterly report"
                  request_type: "llm_chat"
                  user:
                    id: 123
                    email: "analyst@company.com"
                    role: "analyst"
                    permissions: ["query", "llm_chat"]
                    tenant_id: "tenant-abc"
                  client:
                    id: "analytics-app"
                    name: "Analytics Dashboard"
                    org_id: "org-123"
                    tenant_id: "tenant-abc"
                  context:
                    model_preference: "gpt-4"
                  timestamp: "2025-01-15T10:30:00Z"
              skipLLM:
                summary: Skip LLM (testing)
                value:
                  request_id: "test_001"
                  query: "Test query"
                  request_type: "llm_chat"
                  skip_llm: true
                  user:
                    id: 1
                    email: "test@test.com"
                    role: "tester"
                    tenant_id: "test-tenant"
                  client:
                    id: "test-client"
                    name: "Test"
                    tenant_id: "test-tenant"
                  timestamp: "2025-01-15T10:30:00Z"
      responses:
        '200':
          description: Request processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestratorResponse'
              example:
                request_id: "req_12345"
                success: true
                data: "Here is the quarterly report summary..."
                redacted: false
                policy_info:
                  allowed: true
                  applied_policies:
                    - "rate-limit"
                    - "content-filter"
                  risk_score: 0.15
                  processing_time_ms: 5
                provider_info:
                  provider: "openai"
                  model: "gpt-4"
                  response_time_ms: 1250
                  tokens_used: 350
                  cost: 0.021
                processing_time: "1.3s"
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          description: Blocked by dynamic policy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestratorResponse'
              example:
                request_id: "req_12345"
                success: false
                error: "Request blocked by dynamic policy"
                policy_info:
                  allowed: false
                  applied_policies:
                    - "high-risk-content"
                  risk_score: 0.85
                  required_actions:
                    - "approval_required"
                processing_time: "8ms"
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/plan:
    post:
      tags:
        - Multi-Agent Planning
      summary: Execute multi-agent plan
      description: |
        Multi-Agent Planning (MAP) endpoint for complex, multi-step tasks.

        ## How MAP Works
        1. **Decomposition**: LLM analyzes query and breaks into sub-tasks
        2. **Planning**: Creates workflow with dependencies
        3. **Execution**: Runs tasks (parallel when possible)
        4. **Aggregation**: Synthesizes results into final response

        ## Execution Modes
        - `auto`: Automatically determines parallel/sequential (recommended)
        - `parallel`: Force parallel execution
        - `sequential`: Force sequential execution

        ## Domains
        - `travel`: Flights, hotels, itineraries
        - `healthcare`: Medical queries
        - `finance`: Financial analysis
        - `generic`: General-purpose tasks

        **Requires authentication**: Requests must come through the Agent.
      operationId: executePlan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlanRequest'
            examples:
              travelPlan:
                summary: Travel planning
                value:
                  query: "Find flights from NYC to LAX next week and suggest hotels"
                  domain: "travel"
                  execution_mode: "auto"
                  user:
                    id: 123
                    email: "traveler@company.com"
                    role: "employee"
                    permissions: ["query", "mcp_query"]
                    tenant_id: "tenant-abc"
                  client:
                    id: "travel-planner"
                    name: "Travel Planning App"
                  context:
                    departure_date: "2025-01-20"
                    return_date: "2025-01-25"
                    budget: 1500
              genericPlan:
                summary: Generic task
                value:
                  query: "Research competitor pricing and create a summary report"
                  domain: "generic"
                  execution_mode: "sequential"
                  user:
                    id: 456
                    email: "analyst@company.com"
                    role: "analyst"
                    permissions: ["query", "llm_chat"]
                    tenant_id: "tenant-xyz"
      responses:
        '200':
          description: Plan executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanResponse'
              example:
                success: true
                plan_id: "plan_1705312200_abc123"
                workflow_execution_id: "exec_xyz789"
                result:
                  flights:
                    - flight_number: "UA123"
                      price: 299
                      departure: "2025-01-20T08:00:00Z"
                  hotels:
                    - name: "Hilton LAX"
                      price_per_night: 189
                      rating: 4.5
                  summary: "Found 5 flights and 3 hotels within budget"
                metadata:
                  tasks_executed: 3
                  execution_mode: "parallel"
                  execution_time_ms: 3500
                  tasks:
                    - name: "search_flights"
                      status: "completed"
                      time_ms: 1200
                    - name: "search_hotels"
                      status: "completed"
                      time_ms: 1100
                    - name: "synthesize_results"
                      status: "completed"
                      time_ms: 800
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Authentication required: requests must be routed through AxonFlow Agent"
        '503':
          description: Planning engine unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/providers/status:
    get:
      tags:
        - LLM Providers
      summary: Get LLM provider status
      description: Returns status and availability of all configured LLM providers
      operationId: getProviderStatus
      responses:
        '200':
          description: Provider status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderStatusResponse'
              example:
                providers:
                  - name: "openai"
                    available: true
                    models:
                      - "gpt-4"
                      - "gpt-4-turbo"
                      - "gpt-3.5-turbo"
                    weight: 0.4
                    avg_latency_ms: 1200
                  - name: "bedrock"
                    available: true
                    models:
                      - "anthropic.claude-v2"
                      - "amazon.titan-text"
                    weight: 0.4
                    avg_latency_ms: 900
                  - name: "ollama"
                    available: true
                    models:
                      - "llama2"
                      - "mistral"
                    weight: 0.2
                    avg_latency_ms: 500

  /api/v1/providers/weights:
    put:
      tags:
        - LLM Providers
      summary: Update provider routing weights
      description: |
        Update the routing weights for LLM providers.
        Weights determine the probability of routing to each provider.
        Weights must sum to 1.0.
      operationId: updateProviderWeights
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties:
                type: number
                minimum: 0
                maximum: 1
            example:
              openai: 0.5
              bedrock: 0.3
              ollama: 0.2
      responses:
        '200':
          description: Weights updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
              example:
                status: success
                message: "Provider weights updated"
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/policies/dynamic:
    get:
      tags:
        - Dynamic Policies
      summary: List active dynamic policies
      description: Returns all active dynamic policies
      operationId: listDynamicPolicies
      responses:
        '200':
          description: List of dynamic policies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DynamicPolicy'
              example:
                - id: "pol_001"
                  name: "High Risk Content Filter"
                  description: "Block requests with high risk scores"
                  enabled: true
                  conditions:
                    - field: "risk_score"
                      operator: ">"
                      value: 0.8
                  actions:
                    - type: "block"
                      reason: "High risk content detected"
                - id: "pol_002"
                  name: "Rate Limit Premium Users"
                  description: "Apply premium rate limits"
                  enabled: true
                  conditions:
                    - field: "user.role"
                      operator: "=="
                      value: "premium"
                  actions:
                    - type: "rate_limit"
                      limit: 10000

  /api/v1/policies/test:
    post:
      tags:
        - Dynamic Policies
      summary: Test policy evaluation
      description: Test how dynamic policies evaluate a sample request
      operationId: testPolicy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
              properties:
                query:
                  type: string
                user:
                  $ref: '#/components/schemas/UserContext'
                request_type:
                  type: string
            example:
              query: "SELECT * FROM customers WHERE credit_score < 500"
              user:
                id: 123
                email: "analyst@company.com"
                role: "analyst"
              request_type: "sql"
      responses:
        '200':
          description: Policy evaluation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyEvaluationResult'
              example:
                allowed: true
                applied_policies:
                  - "sql-injection-filter"
                  - "pii-protection"
                risk_score: 0.25
                required_actions: []
                processing_time_ms: 3

  /api/v1/metrics:
    get:
      tags:
        - Metrics
      summary: Get detailed metrics
      description: Returns detailed metrics from the metrics collector
      operationId: getDetailedMetrics
      responses:
        '200':
          description: Detailed metrics
          content:
            application/json:
              schema:
                type: object

  /api/v1/audit/search:
    post:
      tags:
        - Audit
      summary: Search audit logs
      description: Search audit logs by various criteria
      operationId: searchAuditLogs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuditSearchRequest'
            example:
              user_email: "analyst@company.com"
              client_id: "analytics-app"
              start_time: "2025-01-01T00:00:00Z"
              end_time: "2025-01-15T23:59:59Z"
              request_type: "llm_chat"
              limit: 100
      responses:
        '200':
          description: Audit search results
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditLogEntry'

  /api/v1/audit/tenant/{tenant_id}:
    get:
      tags:
        - Audit
      summary: Get tenant audit logs
      description: Get recent audit logs for a specific tenant
      operationId: getTenantAuditLogs
      parameters:
        - name: tenant_id
          in: path
          required: true
          description: Tenant identifier
          schema:
            type: string
          example: "tenant-abc"
      responses:
        '200':
          description: Tenant audit logs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditLogEntry'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/workflows/execute:
    post:
      tags:
        - Workflows
      summary: Execute a workflow
      description: Execute a defined workflow with input parameters
      operationId: executeWorkflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowExecuteRequest'
            example:
              workflow:
                metadata:
                  name: "data-analysis-workflow"
                  description: "Analyze sales data"
                spec:
                  steps:
                    - name: "fetch_data"
                      type: "mcp_query"
                      connector: "postgres"
                      query: "SELECT * FROM sales"
                    - name: "analyze"
                      type: "llm"
                      prompt: "Analyze the sales data: {{fetch_data.result}}"
              input:
                start_date: "2025-01-01"
                end_date: "2025-01-15"
              user:
                id: 123
                email: "analyst@company.com"
                role: "analyst"
                tenant_id: "tenant-abc"
      responses:
        '200':
          description: Workflow execution started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowExecution'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/v1/workflows/executions/{id}:
    get:
      tags:
        - Workflows
      summary: Get workflow execution
      description: Get details of a specific workflow execution
      operationId: getWorkflowExecution
      parameters:
        - name: id
          in: path
          required: true
          description: Workflow execution ID
          schema:
            type: string
          example: "exec_abc123"
      responses:
        '200':
          description: Workflow execution details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowExecution'
        '404':
          description: Execution not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/workflows/executions:
    get:
      tags:
        - Workflows
      summary: List workflow executions
      description: List recent workflow executions
      operationId: listWorkflowExecutions
      parameters:
        - name: limit
          in: query
          description: Maximum number of executions to return
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: List of executions
          content:
            application/json:
              schema:
                type: object
                properties:
                  executions:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkflowExecution'
                  count:
                    type: integer

  /api/v1/workflows/executions/tenant/{tenant_id}:
    get:
      tags:
        - Workflows
      summary: Get tenant workflow executions
      description: Get workflow executions for a specific tenant
      operationId: getTenantWorkflowExecutions
      parameters:
        - name: tenant_id
          in: path
          required: true
          description: Tenant identifier
          schema:
            type: string
      responses:
        '200':
          description: Tenant workflow executions
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenant_id:
                    type: string
                  count:
                    type: integer
                  executions:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkflowExecution'

  /api/v1/connectors:
    get:
      tags:
        - Connectors
      summary: List available connectors
      description: List connectors from the marketplace
      operationId: listConnectors
      responses:
        '200':
          description: List of connectors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ConnectorInfo'

  /api/v1/connectors/{id}:
    get:
      tags:
        - Connectors
      summary: Get connector details
      description: Get detailed information about a connector
      operationId: getConnectorDetails
      parameters:
        - name: id
          in: path
          required: true
          description: Connector identifier
          schema:
            type: string
      responses:
        '200':
          description: Connector details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectorInfo'
        '404':
          description: Connector not found

  /api/v1/connectors/{id}/install:
    post:
      tags:
        - Connectors
      summary: Install a connector
      description: Install a connector from the marketplace
      operationId: installConnector
      parameters:
        - name: id
          in: path
          required: true
          description: Connector identifier
          schema:
            type: string
      responses:
        '200':
          description: Connector installed
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/v1/connectors/{id}/uninstall:
    delete:
      tags:
        - Connectors
      summary: Uninstall a connector
      description: Uninstall an installed connector
      operationId: uninstallConnector
      parameters:
        - name: id
          in: path
          required: true
          description: Connector identifier
          schema:
            type: string
      responses:
        '200':
          description: Connector uninstalled
        '404':
          description: Connector not found

  /api/v1/connectors/{id}/health:
    get:
      tags:
        - Connectors
      summary: Check connector health
      description: Check health status of a connector
      operationId: getConnectorHealth
      parameters:
        - name: id
          in: path
          required: true
          description: Connector identifier
          schema:
            type: string
      responses:
        '200':
          description: Connector health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  healthy:
                    type: boolean
                  latency_ms:
                    type: integer
        '404':
          description: Connector not found

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
        service:
          type: string
        version:
          type: string
        timestamp:
          type: string
          format: date-time
        components:
          type: object
          properties:
            policy_engine:
              type: boolean
            llm_router:
              type: boolean
            response_processor:
              type: boolean
            audit_logger:
              type: boolean
            workflow_engine:
              type: boolean
            planning_engine:
              type: boolean
            result_aggregator:
              type: boolean
        features:
          type: object
          properties:
            multi_agent_planning:
              type: boolean

    MetricsResponse:
      type: object
      properties:
        orchestrator_metrics:
          type: object
          properties:
            uptime_seconds:
              type: number
            total_requests:
              type: integer
            success_requests:
              type: integer
            failed_requests:
              type: integer
            blocked_requests:
              type: integer
            success_rate:
              type: number
            rps:
              type: number
            error_rate_per_sec:
              type: number
            dynamic_policy_eval_p50_ms:
              type: number
            dynamic_policy_eval_p95_ms:
              type: number
            dynamic_policy_eval_p99_ms:
              type: number
            llm_routing_p50_ms:
              type: number
            llm_routing_p95_ms:
              type: number
            llm_routing_p99_ms:
              type: number
        health:
          type: object
          properties:
            up:
              type: integer
            consecutive_errors:
              type: integer
        request_types:
          type: object
          additionalProperties:
            type: object
        providers:
          type: object
          additionalProperties:
            type: object
            properties:
              total_calls:
                type: integer
              success_calls:
                type: integer
              failed_calls:
                type: integer
              total_tokens:
                type: integer
              total_cost:
                type: number
              p99_ms:
                type: number
        timestamp:
          type: string
          format: date-time

    OrchestratorRequest:
      type: object
      required:
        - query
        - user
        - client
      properties:
        request_id:
          type: string
          description: Unique request identifier
        query:
          type: string
          description: Query to process
        request_type:
          type: string
          description: Type of request
        skip_llm:
          type: boolean
          default: false
          description: Skip LLM calls (for testing)
        user:
          $ref: '#/components/schemas/UserContext'
        client:
          $ref: '#/components/schemas/ClientContext'
        context:
          type: object
          additionalProperties: true
        timestamp:
          type: string
          format: date-time

    UserContext:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
        role:
          type: string
        permissions:
          type: array
          items:
            type: string
        tenant_id:
          type: string

    ClientContext:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        org_id:
          type: string
        tenant_id:
          type: string

    OrchestratorResponse:
      type: object
      properties:
        request_id:
          type: string
        success:
          type: boolean
        data:
          description: Response data
        error:
          type: string
        redacted:
          type: boolean
        redacted_fields:
          type: array
          items:
            type: string
        policy_info:
          $ref: '#/components/schemas/PolicyEvaluationResult'
        provider_info:
          $ref: '#/components/schemas/ProviderInfo'
        processing_time:
          type: string

    PolicyEvaluationResult:
      type: object
      properties:
        allowed:
          type: boolean
        applied_policies:
          type: array
          items:
            type: string
        risk_score:
          type: number
          minimum: 0
          maximum: 1
        required_actions:
          type: array
          items:
            type: string
        processing_time_ms:
          type: integer
        database_accessed:
          type: boolean

    ProviderInfo:
      type: object
      properties:
        provider:
          type: string
          enum: [openai, anthropic, bedrock, ollama, mock]
        model:
          type: string
        response_time_ms:
          type: integer
        tokens_used:
          type: integer
        cost:
          type: number

    PlanRequest:
      type: object
      required:
        - query
        - user
      properties:
        query:
          type: string
          description: Natural language task description
        domain:
          type: string
          enum: [travel, healthcare, finance, generic]
          default: generic
          description: Task domain for specialized handling
        execution_mode:
          type: string
          enum: [auto, parallel, sequential]
          default: auto
          description: How to execute sub-tasks
        user:
          $ref: '#/components/schemas/UserContext'
        client:
          type: object
          additionalProperties: true
        context:
          type: object
          additionalProperties: true

    PlanResponse:
      type: object
      properties:
        success:
          type: boolean
        plan_id:
          type: string
        workflow_execution_id:
          type: string
        result:
          description: Final aggregated result
        metadata:
          type: object
          properties:
            tasks_executed:
              type: integer
            execution_mode:
              type: string
            execution_time_ms:
              type: integer
            tasks:
              type: array
              items:
                type: object
                properties:
                  name:
                    type: string
                  status:
                    type: string
                  time_ms:
                    type: integer
        error:
          type: string

    ProviderStatusResponse:
      type: object
      properties:
        providers:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              available:
                type: boolean
              models:
                type: array
                items:
                  type: string
              weight:
                type: number
              avg_latency_ms:
                type: integer

    DynamicPolicy:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        enabled:
          type: boolean
        conditions:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              operator:
                type: string
                enum: ["==", "!=", ">", "<", ">=", "<=", "contains", "matches"]
              value:
                description: Comparison value
        actions:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [block, allow, rate_limit, redact, alert]
              reason:
                type: string
              limit:
                type: integer

    AuditSearchRequest:
      type: object
      properties:
        user_email:
          type: string
        client_id:
          type: string
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        request_type:
          type: string
        limit:
          type: integer
          default: 100

    AuditLogEntry:
      type: object
      properties:
        id:
          type: string
        request_id:
          type: string
        timestamp:
          type: string
          format: date-time
        user_email:
          type: string
        client_id:
          type: string
        tenant_id:
          type: string
        request_type:
          type: string
        query_summary:
          type: string
        success:
          type: boolean
        blocked:
          type: boolean
        risk_score:
          type: number
        provider:
          type: string
        tokens_used:
          type: integer
        latency_ms:
          type: integer

    WorkflowExecuteRequest:
      type: object
      required:
        - workflow
      properties:
        workflow:
          $ref: '#/components/schemas/Workflow'
        input:
          type: object
          additionalProperties: true
        user:
          $ref: '#/components/schemas/UserContext'

    Workflow:
      type: object
      required:
        - metadata
        - spec
      properties:
        metadata:
          type: object
          required:
            - name
          properties:
            name:
              type: string
            description:
              type: string
        spec:
          type: object
          required:
            - steps
          properties:
            steps:
              type: array
              items:
                $ref: '#/components/schemas/WorkflowStep'

    WorkflowStep:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
        type:
          type: string
          enum: [mcp_query, llm, api_call, transform]
        connector:
          type: string
        query:
          type: string
        prompt:
          type: string
        dependencies:
          type: array
          items:
            type: string

    WorkflowExecution:
      type: object
      properties:
        id:
          type: string
        workflow_name:
          type: string
        status:
          type: string
          enum: [pending, running, completed, failed]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        steps:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              status:
                type: string
              process_time:
                type: string
        output:
          type: object
          additionalProperties: true

    ConnectorInfo:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
        description:
          type: string
        version:
          type: string
        capabilities:
          type: array
          items:
            type: string
        installed:
          type: boolean
        healthy:
          type: boolean

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "Invalid request body"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: "Internal server error"
