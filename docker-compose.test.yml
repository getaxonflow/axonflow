# Docker Compose for Local Integration Testing
# ==============================================
#
# Purpose: Test full AxonFlow stack locally BEFORE deploying to AWS
# Usage: docker-compose -f docker-compose.test.yml up --build
#
# Why This Matters:
# - 15-minute feedback loop (vs 2-hour AWS deployment)
# - $0 cost (vs $5 per AWS deployment)
# - See exact failures immediately
# - Test migrations, connectivity, all services together
# - Catch 90% of issues before AWS deployment
#
# What This Tests:
# ✅ Database migrations (PostgreSQL 15)
# ✅ Grafana database creation (migration 017)
# ✅ Agent container startup and health
# ✅ Orchestrator container startup and health
# ✅ Customer Portal container startup and health
# ✅ Grafana container connectivity and initialization
# ✅ All service-to-service communication
# ✅ Environment variable configuration
#
# What This Doesn't Test:
# ❌ ECS task definitions (use AWS for this)
# ❌ CloudFormation stack creation
# ❌ ALB + Target Groups (use AWS for this)
# ❌ RDS-specific features (Multi-AZ, backups)
# ❌ Secrets Manager integration (use env vars here)
# ❌ VPC networking / Security Groups
#
# Architecture Differences from AWS:
# - Uses Docker networking instead of ALB
# - Uses Docker volumes instead of EBS
# - Uses PostgreSQL container instead of RDS
# - Uses environment variables instead of Secrets Manager
# - All services on same "host" (Docker network)
#
# Success Criteria:
# - All services show "healthy" status (docker-compose ps)
# - All health endpoints return 200 OK
# - Grafana creates 84 tables in database
# - Agent logs show migrations completed
# - No container restarts or crashes
#
# Created: 2025-11-20 (After 16 consecutive deployment failures)
# Reason: Break the 2-hour AWS feedback loop with 15-minute local testing

version: '3.8'

services:
  # PostgreSQL 15 Database
  # Matches: AWS RDS PostgreSQL 15.x
  # Used by: All services (Agent, Orchestrator, Customer Portal, Grafana)
  postgres:
    image: postgres:15-alpine
    container_name: axonflow-test-postgres
    environment:
      POSTGRES_USER: axonflow
      POSTGRES_PASSWORD: test-password-local-only
      POSTGRES_DB: axonflow
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U axonflow -d axonflow"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - axonflow-test

  # Redis (for Agent rate limiting and caching)
  # Matches: AWS ElastiCache or self-managed Redis
  redis:
    image: redis:7-alpine
    container_name: axonflow-test-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - axonflow-test

  # AxonFlow Agent
  # Purpose: Policy enforcement, LLM routing, MCP queries
  # Runs migrations on startup
  # Creates Grafana database (migration 017)
  agent:
    build:
      context: .
      dockerfile: platform/agent/Dockerfile
    container_name: axonflow-test-agent
    environment:
      # Database Configuration
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: axonflow
      DATABASE_USER: axonflow
      DATABASE_PASSWORD: test-password-local-only
      DATABASE_SSLMODE: disable  # No SSL in local testing (SSL required in AWS)

      # Grafana Configuration (for migration 017)
      GRAFANA_PASSWORD: GrafanaSecurePass2024!

      # License Configuration
      LICENSE_KEY: AXON-TEST-local-testing-20251120-test

      # Redis Configuration
      REDIS_URL: redis://redis:6379

      # Service URLs
      ORCHESTRATOR_URL: http://orchestrator:8081

      # Environment
      ENVIRONMENT: local-testing
      LOG_LEVEL: debug
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s  # Give time for migrations to complete
    networks:
      - axonflow-test

  # AxonFlow Orchestrator
  # Purpose: Multi-agent orchestration, workflow management
  # Depends on Agent for enforcement
  orchestrator:
    build:
      context: .
      dockerfile: platform/orchestrator/Dockerfile
    container_name: axonflow-test-orchestrator
    environment:
      # Database Configuration
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: axonflow
      DATABASE_USER: axonflow
      DATABASE_PASSWORD: test-password-local-only
      DATABASE_SSLMODE: disable

      # Service URLs
      AGENT_URL: http://agent:8080

      # Environment
      ENVIRONMENT: local-testing
      LOG_LEVEL: debug
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
      agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - axonflow-test

  # Customer Portal (Optional - can disable for faster testing)
  # Purpose: Web UI for customers to manage policies, view metrics
  customer-portal:
    build:
      context: .
      dockerfile: platform/customer-portal/Dockerfile
    container_name: axonflow-test-customer-portal
    environment:
      # Database Configuration
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: axonflow
      DATABASE_USER: axonflow
      DATABASE_PASSWORD: test-password-local-only
      DATABASE_SSLMODE: disable

      # Service URLs
      AGENT_URL: http://agent:8080

      # Environment
      ENVIRONMENT: local-testing
      LOG_LEVEL: debug
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8082/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - axonflow-test

  # Grafana
  # Purpose: Metrics visualization, dashboards
  # Uses grafana database created by Agent migration 017
  # Tests that migration 017 actually works
  grafana:
    image: grafana/grafana:latest
    container_name: axonflow-test-grafana
    environment:
      # Database Configuration (uses grafana database created by migration 017)
      GF_DATABASE_TYPE: postgres
      GF_DATABASE_HOST: postgres:5432
      GF_DATABASE_NAME: grafana
      GF_DATABASE_USER: grafana
      GF_DATABASE_PASSWORD: GrafanaSecurePass2024!
      GF_DATABASE_SSL_MODE: disable  # No SSL in local testing

      # Grafana Configuration
      GF_SERVER_HTTP_PORT: 3000
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin-local-only
      GF_USERS_ALLOW_SIGN_UP: 'false'
      GF_INSTALL_PLUGINS: ''

      # Environment
      GF_LOG_LEVEL: debug
    ports:
      - "3000:3000"
    depends_on:
      agent:
        condition: service_healthy  # Wait for migrations to complete
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - axonflow-test

networks:
  axonflow-test:
    name: axonflow-test-network
    driver: bridge

volumes:
  postgres-data:
    name: axonflow-test-postgres-data

# ==============================================
# Testing Instructions
# ==============================================
#
# 1. Build and start all services:
#    docker-compose -f docker-compose.test.yml up --build -d
#
# 2. Watch logs (all services):
#    docker-compose -f docker-compose.test.yml logs -f
#
# 3. Watch logs (specific service):
#    docker-compose -f docker-compose.test.yml logs -f agent
#    docker-compose -f docker-compose.test.yml logs -f grafana
#
# 4. Check service health:
#    docker-compose -f docker-compose.test.yml ps
#    # All services should show "healthy" status
#
# 5. Test health endpoints:
#    curl http://localhost:8080/health  # Agent
#    curl http://localhost:8081/health  # Orchestrator
#    curl http://localhost:8082/health  # Customer Portal
#    curl http://localhost:3000/api/health  # Grafana
#
# 6. Verify Grafana database:
#    docker exec axonflow-test-postgres psql -U axonflow -d axonflow -c "SELECT datname FROM pg_database WHERE datname = 'grafana';"
#    docker exec axonflow-test-postgres psql -U grafana -d grafana -c "SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';"
#    # Should see grafana database and 84 tables
#
# 7. Check Agent logs for migration success:
#    docker-compose -f docker-compose.test.yml logs agent | grep -i migration
#    # Should see: "Migration 017 applied successfully"
#
# 8. Stop all services:
#    docker-compose -f docker-compose.test.yml down
#
# 9. Clean up (delete data):
#    docker-compose -f docker-compose.test.yml down -v
#    docker system prune -f
#
# ==============================================
# Troubleshooting
# ==============================================
#
# Problem: Agent container keeps restarting
# - Check logs: docker-compose logs agent
# - Common causes:
#   - License validation failed (use test license)
#   - Database connection failed (wait for postgres healthy)
#   - Migration failed (check postgres logs)
#
# Problem: Grafana container keeps restarting
# - Check logs: docker-compose logs grafana
# - Common causes:
#   - Migration 017 didn't run (check agent logs)
#   - Grafana database doesn't exist (check postgres)
#   - Wrong password (must match GRAFANA_PASSWORD in agent)
#
# Problem: Services can't reach each other
# - Check network: docker network inspect axonflow-test-network
# - Use service names (not localhost) in URLs
# - Example: agent → http://postgres:5432 (not localhost:5432)
#
# Problem: Slow startup
# - First build takes 5-10 minutes (downloading images, building)
# - Subsequent starts take 30-60 seconds
# - Use --build only when code changes
#
# ==============================================
# Success Criteria (Before AWS Deployment)
# ==============================================
#
# ALL of these must pass before deploying to AWS:
# - [ ] docker-compose ps shows all services "healthy"
# - [ ] All health endpoints return 200 OK
# - [ ] Grafana database exists with 84 tables
# - [ ] Agent logs show migrations completed successfully
# - [ ] No container restarts in last 5 minutes
# - [ ] All services responding for at least 2 minutes
# - [ ] No error messages in any container logs
#
# Only when ALL pass:
# - Build v1.0.17 production images
# - Push to ECR
# - Deploy to AWS staging
# - Monitor with confidence
#
# ==============================================
